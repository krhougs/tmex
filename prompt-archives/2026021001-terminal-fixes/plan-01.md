# Terminal 修复计划（第二轮）

## 背景

在 `prompt-archives/2026021001-terminal-fixes/plan-00.md` 对应的修复合入后，实际体验与结论不一致：页面进入后看不到历史记录，甚至终端区域与内容整体不可用；Sidebar 仍存在可读性与布局问题；前端未正确读取环境变量 `FE_PORT`。

本计划用于：基于现有代码与实际运行结果重新定位根因，完成必要的重构与修复，并补齐 e2e 覆盖，确保功能可用、回归可防。

## 目标

1. 进入设备页后可稳定看到终端内容（至少包含当前 pane 的历史/当前输出），不再出现“什么都看不到”。
2. Sidebar 完全重写：结构清晰、可折叠、active/hover 状态下文字与图标对比度达标，且布局不居中错位。
3. 前端正确读取并使用环境变量 `FE_PORT`（含本地开发与 e2e 启动链路），默认端口与覆盖逻辑明确。
4. 对相关链路做一次系统性 review：tmux 选择、历史捕获、滚动、按键、尺寸同步、移动端布局等，修复发现的阻断性问题。
5. 扩展 e2e 测试：新增对“可见内容、历史、Sidebar active 可读性、端口配置”的覆盖，并保证测试在端口被占用时可自动选择可用端口。

## 注意事项

1. **始终以代码与运行结果为准，禁止猜测**：不确定的行为先复现、抓日志、读源码。
2. 修复优先级：先恢复“可用性”（可见内容/可操作），再做结构性重构（Sidebar）、再补齐体验项。
3. e2e 需要具备稳定性：避免依赖脆弱选择器，必要时添加 `data-testid` 与可访问性属性。
4. 变更需要最小化但要彻底：不接受“先跑通”的临时逻辑。

## 任务清单

- [ ] 复现“空白页/无内容”并定位根因（console error、路由、store、WS、渲染条件）。
- [ ] 修复历史/输出链路：连接后自动订阅并渲染历史；pane 切换时行为一致。
- [ ] 重新实现 Sidebar：信息架构、交互、样式与对比度。
- [ ] 修复并贯通 `FE_PORT`：Vite dev/preview、脚本与 Playwright 启动/探测一致。
- [ ] 全链路 review 并修复阻断问题：按键、滚动、尺寸同步、移动端等。
- [ ] 扩展 e2e：内容可见性、历史加载、Sidebar active 对比度、端口覆盖。
- [ ] 回归：本地跑完关键 e2e，用截图/日志证明行为正确。

## 验收标准

1. 进入设备页 3 秒内能看到终端至少一屏内容（历史或当前输出）。
2. Sidebar active 状态文字与图标对比度满足 WCAG AA（普通文本对比度 ≥ 4.5:1），且布局对齐正确。
3. 设置 `FE_PORT` 后前端实际监听端口与 e2e 访问端口一致；未设置时使用默认端口。
4. 新增 e2e 覆盖在本机端口被占用时仍能通过。
