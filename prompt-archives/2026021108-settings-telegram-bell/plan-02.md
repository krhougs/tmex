# Plan 02：输入草稿持久化与设备管理体验修复

时间：2026-02-11

## 背景

在完成设置页与入口调整后，前端仍存在以下体验问题：
1. 终端编辑器输入框内容在刷新/切页后丢失。
2. 切换页面或 pane 时会出现瞬态 `当前 Pane 已关闭` 提示，造成打扰。
3. 侧边栏底部两个入口按钮布局拥挤。
4. 设备管理缺少“修改设备”能力。
5. 本地设备不需要认证方式，但添加/修改表单仍显示相关字段。

## 目标

1. 编辑器草稿按 pane 持久化，刷新和切换页面不丢失。
2. 仅在真实关闭场景提示 pane 失效，减少瞬态误报。
3. 侧边栏底部“管理设备/设置”改为独立成行。
4. 设备管理支持修改设备信息。
5. 本地设备表单隐藏认证方式相关字段。

## 关键决策

1. 草稿缓存存入 `tmex-ui`（zustand persist），键为 `${deviceId}:${paneId}`。
2. pane 失效 toast 采用延迟 + 去重策略（防抖瞬态切换）。
3. 设备编辑复用现有 `PATCH /api/devices/:id`，前端新增编辑弹窗。
4. 本地设备提交时统一使用 `authMode='auto'`，并隐藏认证字段。
5. 侧边栏展开态按钮采用纵向两行布局，折叠态保留纵向图标按钮。

## 实施任务

1. 扩展 UI store：新增 editorDrafts/set/remove 方法并持久化。
2. 改造 DevicePage：草稿读写回填、发送后清理、pane 失效 toast 降噪。
3. 改造 Sidebar：底部按钮改为纵向两行。
4. 改造 DevicesPage：新增编辑设备能力并抽取/复用设备表单逻辑。
5. 调整设备表单：本地设备隐藏认证字段，SSH 场景保持现有。
6. 回归验证：TS 编译 + 关键 E2E。

## 验收标准

1. 编辑器未发送内容在刷新/切页后保持。
2. 快速切换 pane/window 不再频繁出现“当前 Pane 已关闭”toast。
3. “管理设备/设置”按钮独立成行展示。
4. 设备列表可编辑设备并成功保存。
5. 本地设备添加/编辑不显示认证方式相关输入项。
